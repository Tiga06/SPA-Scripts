import requests
import dns.resolver
import concurrent.futures
from typing import Set, List
import re

class SubdomainEnumerator:
    def __init__(self, domain: str, max_workers: int = 50):
        self.domain = domain
        self.max_workers = max_workers
        self.subdomains = set()
        
    def crt_sh(self) -> Set[str]:
        """Certificate Transparency logs enumeration"""
        try:
            url = f"https://crt.sh/?q=%.{self.domain}&output=json"
            response = requests.get(url, timeout=30)
            if response.status_code == 200:
                data = response.json()
                subs = set()
                for cert in data:
                    name = cert.get('name_value', '')
                    if name:
                        for sub in name.split('\n'):
                            sub = sub.strip().lower()
                            if sub.endswith(f'.{self.domain}') and '*' not in sub:
                                subs.add(sub)
                return subs
        except:
            pass
        return set()
    
    def wordlist_enum(self, wordlist: List[str] = None) -> Set[str]:
        """Wordlist-based subdomain enumeration"""
        if not wordlist:
            wordlist = ['www', 'mail', 'ftp', 'admin', 'test', 'dev', 'staging', 'api', 'app', 'blog', 'shop', 'portal', 'secure', 'vpn', 'remote', 'support', 'help', 'docs', 'cdn', 'static', 'assets', 'img', 'images', 'video', 'media', 'files', 'download', 'upload', 'backup', 'old', 'new', 'beta', 'alpha', 'demo', 'sandbox', 'mobile', 'm', 'wap', 'imap', 'pop', 'smtp', 'webmail', 'email', 'mx', 'ns', 'dns', 'whois', 'cpanel', 'panel', 'control', 'manage', 'dashboard', 'status', 'monitor', 'stats', 'analytics', 'tracking', 'ads', 'ad', 'affiliate', 'partner', 'reseller', 'client', 'customer', 'user', 'member', 'account', 'profile', 'settings', 'config', 'setup', 'install', 'update', 'upgrade', 'patch', 'fix', 'bug', 'issue', 'ticket', 'forum', 'community', 'social', 'chat', 'message', 'news', 'press', 'media', 'photo', 'gallery', 'portfolio', 'resume', 'cv', 'about', 'contact', 'info', 'legal', 'privacy', 'terms', 'policy', 'disclaimer', 'copyright', 'license', 'sitemap', 'robots', 'humans', 'favicon', 'apple-touch-icon', 'browserconfig', 'manifest', 'sw', 'service-worker', 'pwa', 'amp', 'accelerated-mobile-pages', 'instant', 'turbo', 'fast', 'speed', 'performance', 'optimization', 'seo', 'sem', 'marketing', 'campaign', 'promo', 'promotion', 'sale', 'discount', 'coupon', 'deal', 'offer', 'special', 'limited', 'exclusive', 'premium', 'pro', 'plus', 'enterprise', 'business', 'corporate', 'company', 'organization', 'org', 'non-profit', 'charity', 'foundation', 'government', 'gov', 'military', 'mil', 'education', 'edu', 'school', 'university', 'college', 'academy', 'institute', 'research', 'lab', 'library', 'book', 'ebook', 'pdf', 'doc', 'document', 'file', 'archive', 'zip', 'tar', 'gz', 'rar', '7z', 'iso', 'img', 'dmg', 'exe', 'msi', 'deb', 'rpm', 'pkg', 'apk', 'ipa', 'app', 'software', 'program', 'tool', 'utility', 'service', 'platform', 'system', 'network', 'server', 'host', 'cloud', 'saas', 'paas', 'iaas', 'aws', 'azure', 'gcp', 'google', 'microsoft', 'amazon', 'oracle', 'ibm', 'salesforce', 'github', 'gitlab', 'bitbucket', 'docker', 'kubernetes', 'k8s', 'jenkins', 'ci', 'cd', 'devops', 'infrastructure', 'deployment', 'production', 'prod', 'staging', 'stage', 'development', 'dev', 'testing', 'test', 'qa', 'quality', 'assurance', 'security', 'sec', 'audit', 'compliance', 'gdpr', 'hipaa', 'pci', 'sox', 'iso', 'nist', 'owasp', 'cve', 'vulnerability', 'exploit', 'malware', 'virus', 'trojan', 'ransomware', 'phishing', 'spam', 'scam', 'fraud', 'fake', 'counterfeit', 'piracy', 'copyright', 'trademark', 'patent', 'intellectual', 'property', 'ip', 'domain', 'subdomain', 'hostname', 'fqdn', 'url', 'uri', 'link', 'redirect', 'forward', 'proxy', 'reverse', 'load', 'balancer', 'firewall', 'waf', 'ddos', 'protection', 'shield', 'guard', 'defender', 'antivirus', 'anti-malware', 'scanner', 'detector', 'monitor', 'alert', 'notification', 'warning', 'error', 'exception', 'log', 'audit', 'trace', 'debug', 'verbose', 'silent', 'quiet', 'mute', 'disable', 'enable', 'activate', 'deactivate', 'start', 'stop', 'restart', 'reload', 'refresh', 'update', 'upgrade', 'downgrade', 'rollback', 'revert', 'undo', 'redo', 'reset', 'clear', 'clean', 'purge', 'delete', 'remove', 'uninstall', 'install', 'setup', 'configure', 'config', 'setting', 'option', 'parameter', 'argument', 'flag', 'switch', 'toggle', 'checkbox', 'radio', 'button', 'link', 'menu', 'navigation', 'nav', 'header', 'footer', 'sidebar', 'content', 'main', 'body', 'section', 'article', 'div', 'span', 'p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'title', 'meta', 'description', 'keywords', 'author', 'creator', 'publisher', 'editor', 'contributor', 'reviewer', 'moderator', 'administrator', 'admin', 'root', 'superuser', 'user', 'guest', 'anonymous', 'public', 'private', 'protected', 'secure', 'encrypted', 'decrypted', 'hashed', 'salted', 'signed', 'verified', 'authenticated', 'authorized', 'permission', 'role', 'group', 'team', 'department', 'division', 'branch', 'office', 'location', 'region', 'country', 'state', 'province', 'city', 'town', 'village', 'district', 'zone', 'area', 'sector', 'block', 'street', 'road', 'avenue', 'boulevard', 'lane', 'drive', 'way', 'path', 'trail', 'route', 'highway', 'freeway', 'expressway', 'motorway', 'bridge', 'tunnel', 'intersection', 'junction', 'crossroad', 'roundabout', 'traffic', 'light', 'signal', 'sign', 'board', 'billboard', 'advertisement', 'ad', 'banner', 'popup', 'modal', 'dialog', 'window', 'frame', 'iframe', 'embed', 'object', 'applet', 'flash', 'silverlight', 'java', 'javascript', 'js', 'css', 'html', 'xml', 'json', 'yaml', 'toml', 'ini', 'conf', 'config', 'cfg', 'properties', 'env', 'environment', 'variable', 'constant', 'define', 'macro', 'function', 'method', 'procedure', 'subroutine', 'routine', 'algorithm', 'logic', 'code', 'script', 'program', 'application', 'app', 'software', 'firmware', 'hardware', 'device', 'gadget', 'widget', 'component', 'module', 'plugin', 'extension', 'addon', 'theme', 'template', 'layout', 'design', 'style', 'appearance', 'look', 'feel', 'ui', 'ux', 'interface', 'interaction', 'experience', 'usability', 'accessibility', 'responsive', 'mobile', 'tablet', 'desktop', 'laptop', 'computer', 'pc', 'mac', 'linux', 'windows', 'android', 'ios', 'iphone', 'ipad', 'ipod', 'apple', 'google', 'microsoft', 'amazon', 'facebook', 'twitter', 'instagram', 'linkedin', 'youtube', 'tiktok', 'snapchat', 'whatsapp', 'telegram', 'signal', 'discord', 'slack', 'teams', 'zoom', 'skype', 'facetime', 'hangouts', 'meet', 'webex', 'gotomeeting', 'join', 'conference', 'call', 'video', 'audio', 'voice', 'chat', 'message', 'text', 'sms', 'mms', 'email', 'mail', 'letter', 'postcard', 'package', 'parcel', 'delivery', 'shipping', 'logistics', 'supply', 'chain', 'warehouse', 'inventory', 'stock', 'product', 'item', 'goods', 'merchandise', 'commodity', 'service', 'offering', 'solution', 'package', 'bundle', 'deal', 'offer', 'promotion', 'discount', 'sale', 'clearance', 'liquidation', 'auction', 'bid', 'buy', 'sell', 'trade', 'exchange', 'swap', 'barter', 'negotiate', 'bargain', 'haggle', 'price', 'cost', 'fee', 'charge', 'rate', 'tariff', 'tax', 'duty', 'levy', 'fine', 'penalty', 'interest', 'dividend', 'profit', 'loss', 'revenue', 'income', 'expense', 'budget', 'finance', 'money', 'cash', 'credit', 'debit', 'card', 'payment', 'transaction', 'transfer', 'deposit', 'withdrawal', 'balance', 'account', 'bank', 'atm', 'pos', 'terminal', 'machine', 'device', 'equipment', 'tool', 'instrument', 'apparatus', 'mechanism', 'system', 'process', 'procedure', 'method', 'technique', 'approach', 'strategy', 'tactic', 'plan', 'scheme', 'project', 'initiative', 'program', 'campaign', 'operation', 'mission', 'task', 'job', 'work', 'assignment', 'duty', 'responsibility', 'obligation', 'commitment', 'promise', 'agreement', 'contract', 'deal', 'arrangement', 'understanding', 'accord', 'pact', 'treaty', 'alliance', 'partnership', 'collaboration', 'cooperation', 'teamwork', 'joint', 'venture', 'merger', 'acquisition', 'takeover', 'buyout', 'investment', 'funding', 'capital', 'equity', 'debt', 'loan', 'mortgage', 'insurance', 'policy', 'coverage', 'protection', 'security', 'safety', 'risk', 'hazard', 'danger', 'threat', 'vulnerability', 'weakness', 'flaw', 'defect', 'bug', 'error', 'mistake', 'fault', 'failure', 'breakdown', 'malfunction', 'glitch', 'issue', 'problem', 'trouble', 'difficulty', 'challenge', 'obstacle', 'barrier', 'hurdle', 'impediment', 'hindrance', 'obstruction', 'blockage', 'bottleneck', 'constraint', 'limitation', 'restriction', 'regulation', 'rule', 'law', 'statute', 'ordinance', 'code', 'standard', 'specification', 'requirement', 'criteria', 'guideline', 'recommendation', 'suggestion', 'advice', 'tip', 'hint', 'clue', 'indication', 'sign', 'signal', 'symptom', 'evidence', 'proof', 'confirmation', 'verification', 'validation', 'authentication', 'authorization', 'approval', 'permission', 'consent', 'agreement', 'acceptance', 'acknowledgment', 'recognition', 'appreciation', 'gratitude', 'thanks', 'praise', 'compliment', 'feedback', 'review', 'rating', 'score', 'grade', 'mark', 'point', 'level', 'rank', 'position', 'status', 'state', 'condition', 'situation', 'circumstance', 'context', 'environment', 'setting', 'background', 'history', 'past', 'present', 'future', 'time', 'date', 'day', 'week', 'month', 'year', 'decade', 'century', 'millennium', 'era', 'age', 'period', 'phase', 'stage', 'step', 'milestone', 'achievement', 'accomplishment', 'success', 'victory', 'win', 'triumph', 'conquest', 'defeat', 'loss', 'failure', 'setback', 'disappointment', 'frustration', 'anger', 'rage', 'fury', 'wrath', 'irritation', 'annoyance', 'displeasure', 'dissatisfaction', 'unhappiness', 'sadness', 'sorrow', 'grief', 'mourning', 'depression', 'melancholy', 'gloom', 'despair', 'hopelessness', 'pessimism', 'negativity', 'cynicism', 'skepticism', 'doubt', 'uncertainty', 'confusion', 'bewilderment', 'perplexity', 'puzzlement', 'mystery', 'enigma', 'riddle', 'puzzle', 'problem', 'question', 'query', 'inquiry', 'investigation', 'research', 'study', 'analysis', 'examination', 'inspection', 'audit', 'review', 'assessment', 'evaluation', 'appraisal', 'judgment', 'opinion', 'view', 'perspective', 'standpoint', 'viewpoint', 'angle', 'approach', 'method', 'way', 'manner', 'style', 'fashion', 'mode', 'form', 'shape', 'structure', 'organization', 'arrangement', 'layout', 'design', 'pattern', 'model', 'template', 'framework', 'architecture', 'blueprint', 'plan', 'diagram', 'chart', 'graph', 'table', 'list', 'index', 'catalog', 'directory', 'database', 'repository', 'archive', 'library', 'collection', 'set', 'group', 'category', 'class', 'type', 'kind', 'sort', 'variety', 'species', 'genus', 'family', 'order', 'phylum', 'kingdom', 'domain', 'realm', 'sphere', 'field', 'area', 'zone', 'region', 'territory', 'land', 'country', 'nation', 'state', 'province', 'county', 'city', 'town', 'village', 'hamlet', 'settlement', 'community', 'neighborhood', 'district', 'quarter', 'ward', 'precinct', 'sector', 'block', 'lot', 'plot', 'parcel', 'property', 'estate', 'asset', 'resource', 'material', 'substance', 'matter', 'element', 'component', 'part', 'piece', 'fragment', 'portion', 'section', 'segment', 'division', 'unit', 'module', 'block', 'brick', 'stone', 'rock', 'mineral', 'metal', 'alloy', 'compound', 'mixture', 'solution', 'liquid', 'fluid', 'gas', 'vapor', 'steam', 'smoke', 'fog', 'mist', 'cloud', 'sky', 'heaven', 'space', 'universe', 'cosmos', 'galaxy', 'star', 'sun', 'moon', 'planet', 'earth', 'world', 'globe', 'sphere', 'ball', 'circle', 'ring', 'loop', 'cycle', 'rotation', 'revolution', 'orbit', 'path', 'trajectory', 'course', 'route', 'direction', 'way', 'road', 'street', 'avenue', 'boulevard', 'lane', 'alley', 'passage', 'corridor', 'hallway', 'aisle', 'walkway', 'sidewalk', 'pavement', 'curb', 'gutter', 'drain', 'sewer', 'pipe', 'tube', 'hose', 'cable', 'wire', 'cord', 'rope', 'string', 'thread', 'fiber', 'strand', 'filament', 'hair', 'fur', 'feather', 'scale', 'skin', 'hide', 'leather', 'fabric', 'cloth', 'textile', 'material', 'substance', 'stuff', 'thing', 'object', 'item', 'article', 'piece', 'unit', 'element', 'factor', 'aspect', 'feature', 'characteristic', 'trait', 'quality', 'attribute', 'property', 'nature', 'essence', 'core', 'heart', 'center', 'middle', 'interior', 'inside', 'inner', 'internal', 'intrinsic', 'inherent', 'innate', 'natural', 'native', 'indigenous', 'local', 'regional', 'national', 'international', 'global', 'worldwide', 'universal', 'general', 'common', 'ordinary', 'normal', 'regular', 'standard', 'typical', 'usual', 'conventional', 'traditional', 'classic', 'vintage', 'antique', 'old', 'ancient', 'historic', 'historical', 'past', 'former', 'previous', 'prior', 'earlier', 'before', 'ago', 'back', 'behind', 'rear', 'tail', 'end', 'finish', 'conclusion', 'termination', 'completion', 'fulfillment', 'achievement', 'accomplishment', 'success', 'victory', 'triumph', 'win', 'gain', 'profit', 'benefit', 'advantage', 'edge', 'lead', 'head', 'start', 'beginning', 'origin', 'source', 'root', 'base', 'foundation', 'ground', 'floor', 'bottom', 'low', 'down', 'under', 'below', 'beneath', 'underneath', 'sub', 'lower', 'inferior', 'minor', 'lesser', 'smaller', 'little', 'tiny', 'mini', 'micro', 'nano', 'pico', 'femto', 'atto', 'zepto', 'yocto', 'small', 'big', 'large', 'huge', 'giant', 'enormous', 'massive', 'immense', 'vast', 'extensive', 'wide', 'broad', 'long', 'tall', 'high', 'deep', 'thick', 'thin', 'narrow', 'slim', 'slender', 'lean', 'skinny', 'fat', 'obese', 'overweight', 'heavy', 'light', 'bright', 'dark', 'black', 'white', 'gray', 'grey', 'red', 'orange', 'yellow', 'green', 'blue', 'purple', 'pink', 'brown', 'tan', 'beige', 'cream', 'ivory', 'silver', 'gold', 'bronze', 'copper', 'brass', 'steel', 'iron', 'aluminum', 'tin', 'lead', 'zinc', 'nickel', 'chrome', 'platinum', 'palladium', 'rhodium', 'iridium', 'osmium', 'ruthenium', 'rhenium', 'tungsten', 'molybdenum', 'vanadium', 'titanium', 'scandium', 'yttrium', 'lanthanum', 'cerium', 'praseodymium', 'neodymium', 'promethium', 'samarium', 'europium', 'gadolinium', 'terbium', 'dysprosium', 'holmium', 'erbium', 'thulium', 'ytterbium', 'lutetium', 'hafnium', 'tantalum', 'rhenium', 'osmium', 'iridium', 'platinum', 'gold', 'mercury', 'thallium', 'lead', 'bismuth', 'polonium', 'astatine', 'radon', 'francium', 'radium', 'actinium', 'thorium', 'protactinium', 'uranium', 'neptunium', 'plutonium', 'americium', 'curium', 'berkelium', 'californium', 'einsteinium', 'fermium', 'mendelevium', 'nobelium', 'lawrencium', 'rutherfordium', 'dubnium', 'seaborgium', 'bohrium', 'hassium', 'meitnerium', 'darmstadtium', 'roentgenium', 'copernicium', 'nihonium', 'flerovium', 'moscovium', 'livermorium', 'tennessine', 'oganesson']
        
        def check_subdomain(sub):
            try:
                full_domain = f"{sub}.{self.domain}"
                dns.resolver.resolve(full_domain, 'A')
                return full_domain
            except:
                return None
        
        with concurrent.futures.ThreadPoolExecutor(max_workers=self.max_workers) as executor:
            futures = [executor.submit(check_subdomain, sub) for sub in wordlist]
            results = set()
            for future in concurrent.futures.as_completed(futures):
                result = future.result()
                if result:
                    results.add(result)
        return results
    
    def enumerate_all(self, silent: bool = False) -> Set[str]:
        """Combine all enumeration methods"""
        if not silent:
            print(f"[+] Enumerating subdomains for {self.domain}")
        
        # Certificate Transparency
        if not silent:
            print("[+] Checking Certificate Transparency logs...")
        ct_subs = self.crt_sh()
        if not silent:
            print(f"    Found {len(ct_subs)} subdomains from CT logs")
        
        # Wordlist enumeration
        if not silent:
            print("[+] Running wordlist enumeration...")
        wordlist_subs = self.wordlist_enum()
        if not silent:
            print(f"    Found {len(wordlist_subs)} subdomains from wordlist")
        
        # Combine results
        all_subs = ct_subs.union(wordlist_subs)
        if not silent:
            print(f"[+] Total unique subdomains found: {len(all_subs)}")
        
        return all_subs